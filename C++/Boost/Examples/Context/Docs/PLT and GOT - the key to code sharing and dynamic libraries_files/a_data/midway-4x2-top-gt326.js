DISQUS.addBlocks("theme")(function(c){c.blocks.discoveryBoxHelp=function(j,b){var a=new c.Builder,f=DISQUS.extend({},j,b);with(f)return a.put('    <div class="alert">        <a class="close" data-action="discovery-help-close"/>\u00d7</a>        '),a.put(c.interpolate(gettext("Disqus helps you find new and interesting content, discussions and products. Some sponsors and ecommerce sites may pay us for these recommendations and links. %(learnMore)s or %(feedback)s."),{learnMore:c.renderBlock("learnMore"),
feedback:c.renderBlock("feedback")})),a.put("    </div>"),a.compile()};c.blocks.feedback=function(j,b){var a=new c.Builder,f=DISQUS.extend({},j,b);with(f)return a.put('<a href="https://www.surveymonkey.com/s/GHK872T" target="_blank">    '),a.put(gettext("give us feedback")),a.put("</a>"),a.compile()};c.blocks.relatedThread=function(j,b){var a=new c.Builder,f=DISQUS.extend({},j,b);with(f)return a.put('    <li class="discovery-unit">        <div class="main publisher-anchor-color">            <h3 title="'),
a.put((a.esc||function(a){return a})(thread.title)),a.put('">                <a class="title"                href="'),a.put((a.esc||function(a){return a})(thread.redirectUrl)),a.put('"                '),external&&a.put('target="_blank"'),a.put(">"),a.put(thread.title),a.put("</a>            </h3>            "),external&&thread.forum&&thread.forum.name&&(a.put('            <span class="extra eo">'),a.put((a.esc||function(a){return a})(thread.forum.name)),a.put("</span>            ")),a.put('            <span class="extra">            '),
thread.posts?(a.put("                "),thread.posts===1?(a.put("                    "),a.put(gettext("1 comment"))):(a.put("                    "),a.put(c.interpolate(gettext("%(numPosts)s comments"),{numPosts:thread.posts}))),a.put("                ")):(a.put("                "),a.put((a.esc||function(a){return a})(thread.brand))),a.put("            "),a.put("            </span>        </div>    </li>"),a.compile()};c.blocks.learnMore=function(j,b){var a=new c.Builder,f=DISQUS.extend({},j,b);with(f)return a.put('<a href="http://help.disqus.com/customer/portal/articles/666278-introducing-promoted-discovery-and-f-a-q-"   target="_blank">'),
a.put(gettext("Learn more")),a.put("</a>"),a.compile()};c.blocks.relatedThreads=function(j,b){var a=new c.Builder,f=DISQUS.extend({},j,b);with(f)return a.put('<div id="discovery-main" class="extra-links">    <div id="discovery-note" style="display:none;">        '),function(){var e={};c.extend(e,b);c.extend(e,{});a.put(c.renderBlock("discoveryBoxHelp",e))}(),a.put('    </div>    <div id="discovery-content-wrap">        <section id="discovery-external">            <header>                <div id="discovery-options">                    <span class="publisher-anchor-color"><a href="#" id="discovery-help" data-action="discovery-help">'),
a.put(gettext("What's this?")),a.put("</a></span>                    "),a.put("                </div>                <h2>"),a.put(gettext("Recommended For You")),a.put("</h2>            </header>            <ul>                "),a.put('            </ul>        </section>        <section id="discovery-internal">            <header>                <h2>'),a.put(c.interpolate(gettext("Also on %(forumName)s"),{forumName:c.renderBlock("forumName",forum)})),a.put("</h2>            </header>            <ul>                "),
a.put("            </ul>        </section>    </div></div>"),a.compile()};c.blocks.forumName=function(j,b){var a=new c.Builder,f=DISQUS.extend({},j,b);with(f)return a.put("<strong>"),a.put((a.esc||function(a){return a})(name)),a.put("</strong>"),a.compile()}});
(function(c){var j=c.document,b=c.DISQUS;b.registerActions=function(){b.define("discovery.views",function(){var a=!1;return{load:function(f){var e=b.discovery.views;if(a)return e;e.RelatedThreadView=Backbone.View.extend({events:{"click [data-redirect]":"swapLink"},dtplBlock:"relatedThread",swapLink:function(a){a=a.target||a.srcElement;a.tagName.toUpperCase()=="A"&&a.getAttribute("data-redirect")||(a=$(a).closest("a[data-redirect]")[0]);var b=a;b.setAttribute("data-href",b.getAttribute("href"));b.setAttribute("href",
b.getAttribute("data-redirect"));_.delay(function(){b.setAttribute("href",b.getAttribute("data-href"))},100)},renderAvatar:function(a){var b=this.$el.find("[data-role=discovery-avatar]");b.attr("src",a.avatar.cache);b.attr("alt",this.authorName(a));return this},authorName:function(a){return a.name||a.username},render:function(a){var a=a||{},e=a.parent,l=this.model.toJSON();if(!_.isObject(l.forum)&&_.isString(l.forum))l.forum={name:l.forum};this.setElement(b.renderBlock(this.dtplBlock,{thread:l,external:!!a.external,
variant:this.model.collection.variant.name}));e.append(this.$el);f.lineTruncate(this.$el.find("h3 a.title"),{lines:2,ellipsis:!0});this.$el.find("h3, .extra").css({display:"inline"});return this}});e.RelatedThreadCollectionView=Backbone.View.extend({resize:_.debounce(function(){this.trigger("resize")},500),render:function(a){var a=a||{},b=a.limit,l=_.isNumber(b),o=a.start,h=_.isNumber(o);this.collection.each(function(a,d){l&&d>=b||h&&d<o||(new e.RelatedThreadView({model:a})).on("resize",this.resize,
this).render({parent:this.$el.find("ul"),external:!!this.collection.external})},this);return this}});e.AdvertisementCollectionView=Backbone.View.extend({render:function(a){var a=a||{},b=a.limit,l=_.isNumber(b);this.collection.each(function(a,d){l&&d>=b||(new e.RelatedThreadView({model:a})).render({parent:this.$el.find("ul"),external:!0})},this);return this}});e.MainView=Backbone.View.extend({dtplBlock:"relatedThreads",events:{"click [data-action=discovery-close]":"close","click [data-action=discovery-help]":"showHelp",
"click [data-action=discovery-help-close]":"closeHelp"},close:function(a){a.preventDefault();this.remove();this.trigger("resize",0)},showHelp:function(a){a.preventDefault();$(a.currentTarget).hide();this.$el.find("#discovery-note").show();this.trigger("resize")},closeHelp:function(a){a&&a.preventDefault();this.$el.find("#discovery-note").hide();this.trigger("resize")},renderHelp:function(a){this.closeHelp();this.$el.find("[data-action=discovery-help]").show();this.$el.find("#discovery-note").html(b.renderBlock("discoveryBoxHelp",
{session:a.toJSON()}))},render:function(){this.$el.css({position:"static",visibility:"visible"});return this}});a=!0;return e}}});b.define("discovery.collections",function(){var a=!1;return{load:function(f,e){var d=b.discovery.collections;if(a)return d;var c=Backbone.Collection.extend({initialize:function(a,b){this.mainThread=b.thread;this.limit=b.limit;this.variant=b.variant||{};this.external=b.external},fetch:function(a){var b={};b.data={thread:this.mainThread.get("id")};b.parse=!1;_.extend(b,a);
Backbone.Collection.prototype.fetch.call(this,b)},addBandit:function(a){if((a=a.response)&&a.bandit)this.bandit=a.bandit},getBanditJSON:_.memoize(function(){return b.JSON.stringify(this.bandit)}),makeRedirect:function(a,e,h){var d=a?"http://redirect.disqus.com/url":e.link+"#redirect",a={url:a,imp:b.juggler.impId,zone:h.external?"external_discovery":"internal_discovery",forum:this.mainThread.get("forum").id,source_thread_id:this.mainThread.id};this.variant.isExperiment&&_.extend(a,{variant:this.variant.name});
e.advertisement_id?_(a).extend({zone:"promoted_discovery",advertisement_id:e.advertisement_id,body_id:e.body_id}):_(a).extend({thread:e.id});this.bandit&&_.extend(a,{bandit:this.getBanditJSON()});return b.serialize(d,a)}});d.RelatedThreadCollection=c.extend({model:f.RelatedThread,url:b.api.getURL("discovery/listRelated.json"),parse:function(a){this.addBandit(a);var b=[],d=a.response||[];if(d.results)d=d.results;var c=e.log,v=this.mainThread.get("forum");c(this.url,"results (",d.length,"):",d,"ids:",
_.pluck(d,"id"));for(var f=0,j=d.length;f<j&&b.length<this.limit;f++)if(a=d[f].thread||d[f],a.id==this.mainThread.id)c("Thread",a.id,"is same as source thread.");else if(a.posts===0)c("Thread",a.id,"does not have any comments.");else if(a.title.indexOf("http://")===0)c("Thread",a.id,"has a title that starts with http.");else{a.score={score:d[f].score,k:d[f].k};if(a.signedUrl)a.redirectUrl=this.makeRedirect(a.signedUrl,a,{external:a.forum.id!=v.id});b.push(a)}c("Total results after pruning:",b.length);
return b}});d.AdvertisementCollection=c.extend({model:f.Advertisement,url:b.api.getURL("discovery/listPromoted.json"),external:!0,parse:function(a){this.addBandit(a);var b=[],d=a.response||[];if(d.results)d=d.results;e.log(this.url,"results (",d.length,"):",d,"ad_ids:",_.pluck(d,"advertisement_id"));for(var f=0,c=d.length;f<c&&b.length<this.limit;f++)a=d[f],a.redirectUrl=this.makeRedirect(a.signedUrl,a,{external:!0}),b.push(a);return b}});a=!0;return d}}});b.define("discovery.models",function(){var a=
!1;return{load:function(){var f=b.discovery.models;if(a)return f;var e=f.Thread=Backbone.Model.extend({defaults:{author:null,category:null,createdAt:null,forum:null,identifiers:[],ipAddress:null,isClosed:!1,isDeleted:!1,link:null,message:null,slug:null,title:null,userSubscription:!1,posts:0,reactions:0,likes:0,dislikes:0,userScore:0},url:b.api.getURL("threads/details"),parse:function(a){return a.response}});f.RelatedThread=e.extend({defaults:_.defaults({redirectUrl:null,topComment:null},e.prototype.defaults)});
f.Advertisement=Backbone.Model.extend({idAttribute:"body_id",defaults:{brand:"",headline:"",text:"",url:"",advertisement_id:null,body_id:null,redirectUrl:null},get:function(a){if(a==="title")return this.get("headline");return Backbone.Model.prototype.get.call(this,a)},toJSON:function(){var a=this.attributes;return{title:a.headline,brand:a.brand,redirectUrl:a.redirectUrl,link:a.url}}});a=!0;return f}}});b.define("discovery.helpers",function(a,f){var e=null,d=!1,c=!1,l=function(){};a.console&&(l=function(){c&&
(a.console.log.apply?a.console.log.apply(a.console,arguments):a.console.log(_.toArray(arguments).join(" ")))});var o=function(a){if(a===f)return c;c=!!a},h=function(a){if(a===f)return d;d=!!a},s=function(a,b,d){if(e)if(e.length)e.enabled(a)&&b();else{var c=function(){e.enabled(a)&&b();d&&e.off("reset",c)};return void e.on("reset",c)}};return{config:function(a){e=a;h(!0);s("discovery_next:logging",function(){o(!0)})},allowLog:o,ifSwitch:s,log:l,allowLineTruncate:h,lineTruncate:function(c,f){function e(){return h.scrollHeight-
h.offsetHeight>0.2*o}function l(){m.lastChild&&!_.contains(["...","\u2026"],m.lastChild.nodeValue)&&(k=m.appendChild(a.document.createTextNode(" "+r)),e()&&(m.removeChild(k),m.removeChild(m.lastChild),l()))}if(d){var n=b.logError||function(){};if(!c.closest("body").length)return void n("lineTruncate called on el not on DOM");if(c.text().length<1)return void n("lineTruncated called on empty el");if(_.any(c.children(),function(a){return a.nodeType!==3}))return void n("lineTruncate called on non-flat el");
var m=c[0],h=m;if(c.css("display")!=="block")for(;h.parentNode;)if(h=h.parentNode,$(h).css("display")==="block")break;var o=parseFloat(c.css("font-size"),10);if(e()){var f=f||{},n=f.lines||1,r=f.ellipsis,k,g=c.text();if(g.length){var q=c.width()/o,n=parseInt(q*n,10),g=g.split(/\s/),q=0;c.empty();for(var i=0,p=g.length;i<p;i++){q+=g[i].length+1;if(q>=n)break;m.appendChild(j.createTextNode(" "+g[i]))}if(e()){do k=m.removeChild(m.lastChild);while(e())}else{do k=m.appendChild(j.createTextNode(" "+g[i++]));
while(!e()&&i<p);m.removeChild(k)}r&&(_.isString(r)||(r="\u2026"),l())}}}}}});b.define("discovery",function(){return this.overwrites({init:function(a,c){function e(a,b,c,e,f){if(_.isNumber(e)&&a.length<e)return void d();a=new z({el:b,collection:a});a.on("resize",function(){c.trigger("resize")});a.render(f||{});c.trigger("subViewRendered")}function d(c){c=c||{};if(!y){y=!0;var e=b.juggler.client("juggler");if(e){var d={major_version:"midway",internal_organic:k.length,external_organic:g.length,promoted:q.length,
promoted_ids:b.JSON.stringify(q.pluck("advertisement_id")),display:!!c.display},f;if(w.bandit||q.bandit)f=_.extend({},w.bandit,q.bandit);f&&_.extend(d,{bandit:b.JSON.stringify(f)});a.isExperiment&&_.extend(d,{variant:s});o("Juggler init_discovery",d);e.emit("init_discovery",d);l("dark_jester",function(){b.juggler.client("jester",!0).emit("init_discovery",d)})}}}var p=b.discovery.helpers,l=p.ifSwitch,o=p.log,h=a.switches,s=a.variant,v=a.session,u=a.forum,x=a.containerId;p.config(a.switches);var t=
4,n=s.match(/(\d)x\d/);n&&(t=parseInt(n[1],10));var n=$("#"+a.loungeId),m=s.match(/^midway-4x2-top-gt(\d{1,3})$/);m&&(m=m[1],n.height()>m&&v.isAnonymous()&&u.settings.discoveryMax&&h.enabled("discovery_next:top_placement")?x+="-top":t=6);var u=b.discovery.models.load(),n=b.discovery.collections.load(u,p),p=b.discovery.views.load(p),h=n.RelatedThreadCollection,z=p.RelatedThreadCollectionView,n=n.AdvertisementCollection,A=p.AdvertisementCollectionView,r=new u.Thread(_.extend(a.thread,{forum:a.forum})),
t={thread:r,limit:t,variant:{isExperiment:!!a.isExperiment,name:s}},k=new h(null,t),g=new h(null,_.defaults({external:!0},t)),q=new n(null,_.defaults({external:!0},t)),u=[k,g,q];_.invoke(u,"on","error",d);var i=new p.MainView({el:j.getElementById(x)});i.$el.css({position:"absolute",visibility:"hidden",display:"block",width:i.$el.width()});i.$el.append(b.renderBlock(i.dtplBlock,{forum:r.get("forum"),variant:s,session:v.toJSON()}));v.on("change:canModerate",_.bind(i.renderHelp,i,v));_.invoke(u,"on",
"reset",function(){var a=0,b=0,d=!1;return function(e){d||(e.external?b+=e.length:a+=e.length,a<2||b<2||(d=!0,c(i)))}}());i.on("subViewRendered",_.after(2,function(){i.trigger("allSubviewsRendered");d({display:!0})}));var w=new h(null,_.defaults({limit:k.limit+g.limit},t));w.fetch({data:{thread:r.id,external:1,limit:w.limit},success:function(a){if(a.length<2)return void d();var b=r.get("forum"),c;c=a.filter(function(a){return a.get("forum").id!=b.id});a=_.difference(a.models,c);k.reset(a.slice(0,
k.limit)).each(function(a){a.collection=k});a=i.$el.find("#discovery-internal")[0];e(k,a,i,2,{start:0,limit:c.length});o("Internal organic",k.pluck("id"));g.reset(c.slice(0,g.limit)).each(function(a){a.collection=g});g.fetched=!0;o("External organic",g.pluck("id"))},error:d});q.fetch({data:{thread:r.id,limit:q.limit},success:function(a){o("Promoted:",a.pluck("advertisement_id"));var b=i.$el.find("#discovery-external")[0],c=new A({el:b,collection:a}),f=function(){g.off("reset",f);if(k.length<2)return void d();
var h=Math.min(k.length,a.limit),j=Math.min(k.limit,g.length+a.length);j>g.length&&e(k,i.$el.find("#discovery-internal")[0],i,2,{start:g.length,limit:j});g.length>0?(c.render({limit:h-1}),e(g,b,i,2-a.length,{limit:Math.max(h-a.length,1)})):c.render({limit:h});a.length>=2&&i.trigger("subViewRendered")};if(g.fetched)f();else g.on("reset",f)},error:d});var y=!1}})})};b.runThemeScript=b.registerActions})(this);